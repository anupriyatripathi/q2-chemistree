# ----------------------------------------------------------------------------
# Copyright (c) 2016-2018, QIIME 2 development team.
#
# Distributed under the terms of the Modified BSD License.
#
# The full license is in the file LICENSE, distributed with this software.
# ----------------------------------------------------------------------------

from unittest import TestCase, main
from q2_qemistree._semantics import validate_mgf


class FingerprintTests(TestCase):
    def test_validate_mgf(self):
        self.assertTrue(validate_mgf(GOOD_MGF.split('\n')))

    def test_validate_not_enough_ms2s(self):
        with self.assertWarnsRegex(UserWarning, r'At least one feature '
                                   '\\(Feature ID = "5"\\) does not have MS2 '
                                   'information'):
            validate_mgf(BAD_MGF.split('\n'))

    def test_validate_no_ms1(self):
        to_replace = ('BEGIN IONS',
                      'FEATURE_ID=5',
                      'PEPMASS=182.98443603515625',
                      'CHARGE=1+',
                      'RTINSECONDS=464.817',
                      'SPECTYPE=CORRELATED MS',
                      'MSLEVEL=1',
                      'FILENAME=CLA_1-2.mzXML;END_1-10.mzXML;',
                      'SCANS=-1',
                      '182.98443603515625 100.0',
                      'END IONS')
        to_replace = '\n'.join(to_replace)
        # remove feature 5 and make it only mslevel2
        bad = BAD_MGF.replace(to_replace,
                              to_replace.replace('MSLEVEL=1', 'MSLEVEL=2'))

        with self.assertRaisesRegex(ValueError, 'Feature "5" does not have an'
                                    ' MSLEVEL=1 record'):
            validate_mgf(bad.split('\n'))

    def test_validate_no_trailing_ms1(self):
        bad = ["BEGIN IONS",
               "FEATURE_ID=6",
               "PEPMASS=154.98995971679688",
               "CHARGE=1+",
               "RTINSECONDS=464.817",
               "SPECTYPE=CORRELATED MS",
               "MSLEVEL=2",
               "FILENAME=CLA_1-2.mzXML;END_1-10.mzXML;LA_1-2.mzXML;",
               "SCANS=-1",
               "154.98995971679688 1.63689952E8",
               "155.99267578125 9081757.0",
               "END IONS"]

        bad = '\n'.join(bad)
        bad = GOOD_MGF + '\n\n' + bad

        with self.assertRaisesRegex(ValueError, 'Feature "6" does not have an'
                                    ' MSLEVEL=1 record'):
            validate_mgf(bad.split('\n'))

    def test_validate_more_than_one_ms1(self):
        doubled = ["BEGIN IONS",
                   "FEATURE_ID=6",
                   "PEPMASS=154.98995971679688",
                   "CHARGE=1+",
                   "RTINSECONDS=464.817",
                   "SPECTYPE=CORRELATED MS",
                   "MSLEVEL=1",
                   "FILENAME=CLA_1-2.mzXML;END_1-10.mzXML;LA_1-2.mzXML;",
                   "SCANS=-1",
                   "154.98995971679688 1.63689952E8",
                   "155.99267578125 9081757.0",
                   "END IONS"]

        doubled = '\n'.join(doubled)
        doubled = GOOD_MGF + '\n\n' + doubled + '\n\n' + doubled

        with self.assertRaisesRegex(ValueError, 'Feature "6" has more than one'
                                    ' MSLEVEL=1 record'):
            validate_mgf(doubled.split('\n'))


GOOD_MGF = """BEGIN IONS
FEATURE_ID=1
PEPMASS=267.137451171875
CHARGE=1+
RTINSECONDS=186.237
SPECTYPE=CORRELATED MS
MSLEVEL=1
FILENAME=END_1-10.mzXML;Oleic_1-10.mzXML
SCANS=-1
267.137451171875 8.0005088E8
268.14239501953125 1.48352336E8
269.144775390625 1.5245118E7
END IONS

BEGIN IONS
FEATURE_ID=1
PEPMASS=267.137451171875
CHARGE=1+
RTINSECONDS=186.237
MSLEVEL=2
FILENAME=END_1-10.mzXML
79.05414581298828 30067.116088867188
91.0543212890625 18327.923828125
93.06949615478516 12539.17919921875
95.04891204833984 7710.0263671875
103.05429077148438 14202.93701171875
END IONS

BEGIN IONS
FEATURE_ID=3
PEPMASS=110.02030181884766
CHARGE=2+
RTINSECONDS=464.817
SPECTYPE=CORRELATED MS
MSLEVEL=1
FILENAME=CLA_1-2.mzXML;END_1-10.mzXML;
SCANS=-1
110.02030181884766 3.7130912E8
110.52145385742188 3.7600168E7
END IONS

BEGIN IONS
FEATURE_ID=3
PEPMASS=110.02030181884766
CHARGE=2+
RTINSECONDS=465.22
MSLEVEL=2
FILENAME=CLA_1-2.mzXML
88.50355529785156 38604.94140625
90.94837951660156 17430.9765625
96.00914764404297 140425.046875
96.50989532470703 12976.2353515625
97.00919342041016 51549.67578125
98.5119400024414 151859.65625
99.06878662109375 8212.6845703125
99.51173400878906 9424.76953125
107.81053924560547 8508.6982421875
109.07559967041016 52629.62109375
110.06009674072266 121515.328125
END IONS

BEGIN IONS
FEATURE_ID=3
PEPMASS=110.02030181884766
CHARGE=2+
RTINSECONDS=465.27
MSLEVEL=2
FILENAME=END_1-10.mzXML
56.05004119873047 9330.11328125
65.03883361816406 2950.2132568359375
66.0342025756836 4933.19140625
67.04166412353516 1107.313720703125
67.0547866821289 35077.21423339844
68.0500717163086 30219.210205078125
69.04480743408203 152570.82092285156
END IONS

BEGIN IONS
FEATURE_ID=3
PEPMASS=110.02030181884766
CHARGE=2+
RTINSECONDS=465.27
MSLEVEL=2
FILENAME=END_1-10.mzXML
94.06526184082031 8265.1220703125
95.060302734375 4093.828369140625
96.00962829589844 34267.1396484375
96.01512908935547 1244.4327392578125
96.06775665283203 16547.947265625
97.00996398925781 17980.67919921875
98.5124740600586 47074.67138671875
99.01335906982422 1503.0234375
108.9588394165039 9064.17236328125
END IONS


BEGIN IONS
FEATURE_ID=3
PEPMASS=110.02030181884766
CHARGE=2+
RTINSECONDS=465.543
MSLEVEL=2
FILENAME=LA_1-2.mzXML
114.9659652709961 13171.9140625
115.96392822265625 59194.9609375
131.974853515625 220007.52368164062
172.77825927734375 12715.599609375
178.47755432128906 15636.3701171875
211.69873046875 13603.1630859375
END IONS
"""

BAD_MGF = """BEGIN IONS
FEATURE_ID=1
PEPMASS=267.137451171875
CHARGE=1+
RTINSECONDS=186.237
SPECTYPE=CORRELATED MS
MSLEVEL=1
FILENAME=END_1-10.mzXML;Oleic_1-10.mzXML
SCANS=-1
267.137451171875 8.0005088E8
268.14239501953125 1.48352336E8
269.144775390625 1.5245118E7
END IONS

BEGIN IONS
FEATURE_ID=1
PEPMASS=267.137451171875
CHARGE=1+
RTINSECONDS=186.237
MSLEVEL=2
FILENAME=END_1-10.mzXML
79.05414581298828 30067.116088867188
91.0543212890625 18327.923828125
93.06949615478516 12539.17919921875
95.04891204833984 7710.0263671875
103.05429077148438 14202.93701171875
END IONS

BEGIN IONS
FEATURE_ID=3
PEPMASS=110.02030181884766
CHARGE=2+
RTINSECONDS=464.817
SPECTYPE=CORRELATED MS
MSLEVEL=1
FILENAME=CLA_1-2.mzXML;END_1-10.mzXML;
SCANS=-1
110.02030181884766 3.7130912E8
110.52145385742188 3.7600168E7
END IONS

BEGIN IONS
FEATURE_ID=3
PEPMASS=110.02030181884766
CHARGE=2+
RTINSECONDS=465.22
MSLEVEL=2
FILENAME=CLA_1-2.mzXML
88.50355529785156 38604.94140625
90.94837951660156 17430.9765625
96.00914764404297 140425.046875
96.50989532470703 12976.2353515625
97.00919342041016 51549.67578125
98.5119400024414 151859.65625
99.06878662109375 8212.6845703125
99.51173400878906 9424.76953125
107.81053924560547 8508.6982421875
109.07559967041016 52629.62109375
110.06009674072266 121515.328125
END IONS

BEGIN IONS
FEATURE_ID=3
PEPMASS=110.02030181884766
CHARGE=2+
RTINSECONDS=465.27
MSLEVEL=2
FILENAME=END_1-10.mzXML
56.05004119873047 9330.11328125
65.03883361816406 2950.2132568359375
66.0342025756836 4933.19140625
67.04166412353516 1107.313720703125
67.0547866821289 35077.21423339844
68.0500717163086 30219.210205078125
69.04480743408203 152570.82092285156
END IONS

BEGIN IONS
FEATURE_ID=5
PEPMASS=182.98443603515625
CHARGE=1+
RTINSECONDS=464.817
SPECTYPE=CORRELATED MS
MSLEVEL=1
FILENAME=CLA_1-2.mzXML;END_1-10.mzXML;
SCANS=-1
182.98443603515625 100.0
END IONS

BEGIN IONS
FEATURE_ID=6
PEPMASS=154.98995971679688
CHARGE=1+
RTINSECONDS=464.817
SPECTYPE=CORRELATED MS
MSLEVEL=1
FILENAME=CLA_1-2.mzXML;END_1-10.mzXML;LA_1-2.mzXML;
SCANS=-1
154.98995971679688 1.63689952E8
155.99267578125 9081757.0
END IONS

BEGIN IONS
FEATURE_ID=6
PEPMASS=154.98995971679688
CHARGE=1+
RTINSECONDS=465.543
MSLEVEL=2
FILENAME=LA_1-2.mzXML
50.652095794677734 6423.314453125
51.43205642700195 4944.70068359375
55.788978576660156 9456.29150390625
55.934715270996094 28810.517211914062
56.96533966064453 34174.27880859375
58.06582260131836 10099.0546875
58.712886810302734 5465.88916015625
61.17979431152344 4944.26513671875
65.33447265625 9092.836181640625
66.22406005859375 5317.72021484375
68.48184204101562 6043.7333984375
70.94202423095703 6628.13427734375
70.95789337158203 22372.8369140625
71.92931365966797 12984.814453125
71.94048309326172 116670.94360351562
71.9519271850586 547516.6381835938
71.95536041259766 8184.0537109375
72.93738555908203 8172705.546875
73.93780517578125 184398.22106933594
74.93749237060547 102062.40893554688
74.94171142578125 9743.2587890625
81.94607543945312 9560.510131835938
81.95099639892578 7816.46044921875
85.9802017211914 5813.82177734375
90.94745635986328 1816875.96875
91.94779205322266 25441.48193359375
92.9477767944336 8989.330078125
96.96107482910156 17080.12060546875
100.94307708740234 8859.353149414062
END IONS
"""

if __name__ == '__main__':
    main()
